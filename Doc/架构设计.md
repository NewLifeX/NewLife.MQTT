# NewLife.MQTT �ܹ����

## ����

NewLife.MQTT ��һ��**�����������з����������������MIT ��Դ**�� MQTT ����Э��ʵ�֣�ͬʱ�����ͻ��� `MqttClient` �ͷ���� `MqttServer`�����ĵ���ϸ��������ϵͳ�ļܹ���ơ��������̣������� MQTT 3.1.1 �� MQTT 5.0 Э��Ĳ��졣

**�������Ŀ�꣺**
- **����ʵ��** �� MQTT 3.1.1 / MQTT 5.0 Э��ȫ��֧��
- **������** �� ������ NewLife.Core �����⣬�޹�Ӧ����ȫ����
- **������** �� �����򼶲������ӣ����� TPS
- **����չ** �� ��������ע��Ĳ�����ܹ�
- **��������** �� ��Ⱥ/�Ž�/��������/WebHook ����ҵ����������

---

## һ��ϵͳ�ܹ�����

### 1.1 �ֲ�ܹ�

```
������������������������������������������������������������������������������������������������������������������������������
��                       Ӧ�ò� Application                     ��
��  NewLife.MqttServer �� MqttClient �� AliyunMqttClient �� ...  ��
������������������������������������������������������������������������������������������������������������������������������
������������������������������������������������������������������������������������������������������������������������������
��                      ҵ��� Business                         ��
��  MqttServer �� MqttExchange �� MqttBridge �� MqttRuleEngine   ��
��  MqttWebHook �� ClusterServer �� IMqttAuthenticator �� ...    ��
������������������������������������������������������������������������������������������������������������������������������
������������������������������������������������������������������������������������������������������������������������������
��                     Э��� Protocol                          ��
��  MqttHandler �� MqttFactory �� 15����Ϣ���� �� MqttCodec     ��
��  MqttProperties(30������) �� MqttTopicFilter �� ...          ��
������������������������������������������������������������������������������������������������������������������������������
������������������������������������������������������������������������������������������������������������������������������
��                     ����� Transport                         ��
��  TCP �� TLS �� WebSocket �� WSS �� QUIC �� �ɿ�UDP �� Proxy    ��
������������������������������������������������������������������������������������������������������������������������������
������������������������������������������������������������������������������������������������������������������������������
��                     ������ Foundation                        ��
��         NewLife.Core (����/���л�/��־/����/׷��)             ��
������������������������������������������������������������������������������������������������������������������������������
```

### 1.2 ����ģ���ϵ

```
              ������������������������������
              �� MqttServer  �� ��������
              ���������������Щ�������������
                     ��
        ���������������������������੤������������������������
        ��            ��            ��
   ����������������������  ��������������������  ����������������������
   ��MqttCodec��  ��Session ��  ��Exchange �� ������Ԫ��
   �����������Щ���������  ���������Щ���������  ���������Щ�����������
        ��           ��            ��
   ������������������������������������������������������������������������
   ��15����Ϣ  ����MqttHandler��������·��  ��
   ������ʵ��  ����(����չ)   ����Retain�洢��
   ��������������������������������������������������������������������������
        ��
   ����������������������������������������������������������
   ��  IMqttAuthenticator       �� �ɲ��ģ��
   ��  MqttBridge               ��
   ��  MqttRuleEngine           ��
   ��  MqttWebHook              ��
   ��  ClusterServer            ��
   ����������������������������������������������������������
```

---

## ����Э������

### 2.1 ��Ϣ�����빤��ģʽ

**15�� MQTT ��Ϣ���ͣ�**

| ����ֵ | ��Ϣ���� | ���� | ���� | 3.1.1 | 5.0 |
|-------|---------|------|------|-------|-----|
| 1 | CONNECT | `ConnectMessage` | C��S | ? | ? |
| 2 | CONNACK | `ConnAck` | S��C | ? | ? |
| 3 | PUBLISH | `PublishMessage` | ˫�� | ? | ? |
| 4 | PUBACK | `PubAck` | ˫�� | ? | ? |
| 5 | PUBREC | `PubRec` | ˫�� | ? | ? |
| 6 | PUBREL | `PubRel` | ˫�� | ? | ? |
| 7 | PUBCOMP | `PubComp` | ˫�� | ? | ? |
| 8 | SUBSCRIBE | `SubscribeMessage` | C��S | ? | ? |
| 9 | SUBACK | `SubAck` | S��C | ? | ? |
| 10 | UNSUBSCRIBE | `UnsubscribeMessage` | C��S | ? | ? |
| 11 | UNSUBACK | `UnsubAck` | S��C | ? | ? |
| 12 | PINGREQ | `PingRequest` | C��S | ? | ? |
| 13 | PINGRESP | `PingResponse` | S��C | ? | ? |
| 14 | DISCONNECT | `DisconnectMessage` | ˫�� | ? | ? |
| 15 | AUTH | `AuthMessage` | ˫�� | �� | ? |

**����ģʽ������Ϣ��**

```csharp
// MqttFactory.cs
public MqttMessage? ReadMessage(IPacket pk)
{
    var stream = pk.GetStream();
    var flag = stream.ReadByte();
    var type = (MqttType)((flag & 0b1111_0000) >> 4);
    
    var msg = type switch
    {
        MqttType.Connect => new ConnectMessage(),
        MqttType.ConnAck => new ConnAck(),
        MqttType.Publish => new PublishMessage(),
        MqttType.PubAck => new PubAck(),
        MqttType.Subscribe => new SubscribeMessage(),
        MqttType.Auth => new AuthMessage(), // MQTT 5.0
        // ...
        _ => null
    };
    
    if (msg != null && msg.Read(stream, context))
        return msg;
    return null;
}
```

### 2.2 �̶�ͷ�������

**�̶�ͷ���ṹ��2+ �ֽڣ���**

```
�����������������������Щ��������������������Щ�����������������������������������������������������������������������������
�� Byte 1   �� Byte 2-5 �� Payload                              ��
�����������������������੤�������������������੤����������������������������������������������������������������������������
�� 4bit���� �� ʣ�೤�� �� �ɱ�ͷ�� + ��Ч�غ�                   ��
�� 4bit��־ �� (�䳤)   ��                                      ��
�����������������������ة��������������������ة�����������������������������������������������������������������������������

Byte 1 ��־λ��
  7 6 5 4 | 3       | 2 1     | 0
  --------+---------+---------+--------
  Type    | DUP     | QoS     | Retain
  (��Ϣ����) (�ظ�)   (��������) (����)
```

**�䳤�������루Remaining Length����**

```csharp
// д��䳤������֧�� 0 ~ 268,435,455��
public static void WriteEncodedInt(this Stream stream, Int32 value)
{
    do
    {
        var b = (Byte)(value % 128);
        value /= 128;
        if (value > 0) b |= 0x80;  // ���λ=1 ��ʾ���������ֽ�
        stream.WriteByte(b);
    } while (value > 0);
}

// ��ȡ�䳤����
public static Int32 ReadEncodedInt(this Stream stream)
{
    var result = 0;
    var multiplier = 1;
    Byte b;
    do
    {
        b = (Byte)stream.ReadByte();
        result += (b & 0x7F) * multiplier;
        multiplier *= 128;
    } while ((b & 0x80) != 0);
    return result;
}
```

### 2.3 MQTT 5.0 ����ϵͳ

**30�����Ա�ʶ������֧�֣�**

| ����ID | ���� | �������� | ��; |
|--------|------|---------|------|
| 0x01 | PayloadFormatIndicator | Byte | �غɸ�ʽ��0=������, 1=UTF-8�� |
| 0x02 | MessageExpiryInterval | UInt32 | ��Ϣ���ڼ����룩 |
| 0x03 | ContentType | String | �������ͣ�MIME type�� |
| 0x08 | ResponseTopic | String | ��Ӧ���⣨����/��Ӧģʽ�� |
| 0x09 | CorrelationData | Binary | �������ݣ�����/��Ӧģʽ�� |
| 0x0B | SubscriptionIdentifier | �䳤���� | ���ı�ʶ�� |
| 0x11 | SessionExpiryInterval | UInt32 | �Ự���ڼ����룩 |
| 0x12 | AssignedClientIdentifier | String | ����˷���Ŀͻ��˱�ʶ |
| 0x13 | ServerKeepAlive | UInt16 | ����˱�������ʱ�� |
| 0x15 | AuthenticationMethod | String | ��֤������ |
| 0x16 | AuthenticationData | Binary | ��֤���� |
| 0x21 | ReceiveMaximum | UInt16 | �������ֵ�����أ� |
| 0x22 | TopicAliasMaximum | UInt16 | ����������ֵ |
| 0x23 | TopicAlias | UInt16 | ������� |
| 0x24 | MaximumQoS | Byte | ���QoS |
| 0x25 | RetainAvailable | Byte | ������Ϣ���� |
| 0x26 | UserProperty | �ַ����� | �û��Զ������ԣ��ɶ�Σ� |
| 0x27 | MaximumPacketSize | UInt32 | ����Ĵ�С |
| ... | ... | ... | ... |

**���Զ�дʾ����**

```csharp
// MqttProperties.cs
public class MqttProperties
{
    private Dictionary<MqttPropertyId, Object> _properties = new();
    
    // д�����Լ��ϵ���
    public void Write(Stream stream)
    {
        // 1. �ȼ��������ܳ���
        var ms = new MemoryStream();
        foreach (var (id, value) in _properties)
        {
            ms.WriteByte((Byte)id);
            WritePropertyValue(ms, id, value);
        }
        
        // 2. д�볤�ȣ��䳤������
        stream.WriteEncodedInt((Int32)ms.Length);
        
        // 3. д����������
        ms.Position = 0;
        ms.CopyTo(stream);
    }
    
    // ������ȡ���Լ���
    public void Read(Stream stream)
    {
        var len = stream.ReadEncodedInt();
        if (len == 0) return;
        
        var end = stream.Position + len;
        while (stream.Position < end)
        {
            var id = (MqttPropertyId)stream.ReadByte();
            var value = ReadPropertyValue(stream, id);
            _properties[id] = value;
        }
    }
}
```

---

## ����MQTT 3.1.1 ��������

### 3.1 �������̣�CONNECT / CONNACK��

```
��������������������                                    ��������������������
�� Client ��                                    �� Server ��
���������Щ���������                                    ���������Щ���������
    ��                                             ��
    ��  �� TCP �������ֽ�������                      ��
    ��������������������������������������������������������������������������������������������>��
    ��                                             ��
    ��  �� CONNECT ����                             ��
    ��    - ClientId, Username, Password          ��
    ��    - KeepAlive, CleanSession               ��
    ��    - Will Topic/Message/QoS/Retain         ��
    ��������������������������������������������������������������������������������������������>��
    ��                                             ��
    ��                       �� ����˴����         ��
    ��                          - ��֤�û���/����   ��
    ��                          - ����/�ָ��Ự     ��
    ��                          - ע�ᵽ Exchange  ��
    ��                                             ��
    ��  �� CONNACK ����                             ��
    ��    - ConnectReturnCode (0=Success)         ��
    ��    - SessionPresent (�Ự�Ѵ���)            ��
    ��<��������������������������������������������������������������������������������������������
    ��                                             ��
    ��  �� �� CleanSession=0 �� SessionPresent=1:   ��
    ��     �ָ����Ĺ�ϵ + ����������Ϣ               ��
    ��<��������������������������������������������������������������������������������������������
    ��                                             ��
```

**��������Ӵ����߼���**

```csharp
// MqttHandler.cs
protected override ConnAck OnConnect(ConnectMessage message)
{
    var ack = new ConnAck { Code = ConnectReturnCode.Accepted };
    
    // 1. ��֤
    if (Authenticator != null)
    {
        var code = Authenticator.Authenticate(
            message.ClientId, 
            message.Username, 
            message.Password
        );
        if (code != ConnectReturnCode.Accepted)
        {
            ack.Code = code;
            return ack;
        }
    }
    
    // 2. ���� ClientId
    ClientId = message.ClientId;
    
    // 3. ����/�ָ��Ự
    if (message.CleanSession)
        Exchange.ClearPersistentSession(ClientId);
    else
        Exchange.RestorePersistentSession(this, ClientId);
    
    // 4. ע�ᵽ������
    Exchange.RegisterClientId(SessionId, ClientId);
    
    // 5. ����������Ϣ
    if (message.HasWill)
    {
        _willTopic = message.WillTopicName;
        _willMessage = message.WillMessage;
        _willQoS = message.WillQualityOfService;
        _willRetain = message.WillRetain;
    }
    
    return ack;
}
```

### 3.2 ����/��������

**�������̣�SUBSCRIBE / SUBACK����**

```
��������������������                                    ��������������������
�� Client ��                                    �� Server ��
���������Щ���������                                    ���������Щ���������
    ��                                             ��
    ��  �� SUBSCRIBE                                ��
    ��    - PacketId = 1                          ��
    ��    - Topics: ["sensors/+/temp", "alert/#"] ��
    ��    - QoS: [1, 0]                           ��
    ��������������������������������������������������������������������������������������������>��
    ��                                             ��
    ��                       �� ����˴����         ��
    ��                          - Ȩ�޼�� (ACL)   ��
    ��                          - ע�ᵽ _topics   ��
    ��                          - ���� Retain ��Ϣ ��
    ��                                             ��
    ��  �� SUBACK                                   ��
    ��    - PacketId = 1                          ��
    ��    - GrantedQoS: [1, 0]                    ��
    ��<��������������������������������������������������������������������������������������������
    ��                                             ��
```

**�������̣�QoS 0 / 1 / 2����**

```
# QoS 0 - ����һ�Σ�Fire and Forget��
Client ����PUBLISH(QoS=0)����> Server
    ����Ӧ����Ϣ���ܶ�ʧ��

# QoS 1 - ����һ�Σ��� ACK��
Client ����PUBLISH(QoS=1, Id=1)����> Server
Client <����PUBACK(Id=1)�������������������� Server
    ����Ϣ���ٵ���һ�Σ������ظ���

# QoS 2 - ǡ��һ�Σ��Ĳ����֣�
Client ����PUBLISH(QoS=2, Id=1)����> Server  �� ����
Client <����PUBREC(Id=1)�������������������� Server  �� �յ�ȷ��
Client ����PUBREL(Id=1)��������������������> Server  �� �ͷ�
Client <����PUBCOMP(Id=1)������������������ Server  �� ���
    ����Ϣǡ�õ���һ�Σ����ظ���
```

**��Ϣ�ַ��߼���**

```csharp
// MqttExchange.cs
public virtual void Publish(PublishMessage message, Int32 publisherSessionId = -1)
{
    // 1. ���� Retain ��Ϣ
    if (message.Retain)
    {
        if (message.Payload == null || message.Payload.Total == 0)
            _retainMessages.TryRemove(message.Topic, out _);  // ����Ϣ���
        else
            _retainMessages[message.Topic] = message;  // �洢������Ϣ
    }
    
    // 2. ����ƥ��Ķ�����
    var subscribers = new List<(IMqttHandler, QoS, SubscriptionOptions)>();
    foreach (var (filter, subList) in _topics)
    {
        if (MqttTopicFilter.IsMatch(message.Topic, filter))
        {
            foreach (var sub in subList)
            {
                // NoLocal: ��ת��������������
                if (sub.NoLocal && sub.SessionId == publisherSessionId)
                    continue;
                    
                if (_sessions.TryGetValue(sub.SessionId, out var handler))
                    subscribers.Add((handler, sub.QoS, sub.Options));
            }
        }
    }
    
    // 3. �����߷ַ���Ϣ
    foreach (var (handler, subQoS, options) in subscribers)
    {
        // QoS ������ȡ����QoS�Ͷ���QoS�н�Сֵ
        var qos = (QualityOfService)Math.Min((Int32)message.QoS, (Int32)subQoS);
        
        var pub = new PublishMessage
        {
            Topic = message.Topic,
            Payload = message.Payload,
            QoS = qos,
            Retain = options.RetainAsPublished ? message.Retain : false,
        };
        
        handler.Publish(pub);
    }
}
```

### 3.3 ������Ϣ����

```
��������������������                                    ��������������������
�� Client ��                                    �� Server ��
���������Щ���������                                    ���������Щ���������
    ��                                             ��
    ��  �� CONNECT ��������Ϣ                        ��
    ��    - WillTopic = "device/offline"          ��
    ��    - WillMessage = "Device A offline"      ��
    ��    - WillQoS = 1, WillRetain = true        ��
    ��������������������������������������������������������������������������������������������>��
    ��                                             �� ����˱�������
    ��                                             ��
    ��  �� ����ͨ��...                               ��
    ��<����������������������������������������������������������������������������������������>��
    ��                                             ��
    ��  �� �쳣�Ͽ���������� / ��ʱ��                ��
    ��  X                                          ��
    ��                                             ��
    ��                       �� ����˼�⵽�쳣�Ͽ� ��
    ��                          ����������Ϣ��      ��
    ��                          Topic: device/offline��
    ��                          Payload: "Device A offline"��
    ��                          QoS: 1, Retain: true��
    ��                                             ��
```

**��������������**

```csharp
// MqttHandler.cs
public virtual void Close(String reason)
{
    // ��������� DISCONNECT���������
    if (_normalDisconnect)
    {
        _willTopic = null;
        _willMessage = null;
    }
    // �쳣�Ͽ�����������
    else if (!_willTopic.IsNullOrEmpty())
    {
        var pub = new PublishMessage
        {
            Topic = _willTopic,
            Payload = _willMessage,
            QoS = _willQoS,
            Retain = _willRetain,
        };
        
        // ���͵����� Exchange �ͼ�Ⱥ ClusterExchange
        Exchange?.Publish(pub, SessionId);
        ClusterExchange?.Publish(pub);
    }
}
```

---

## �ġ�MQTT 5.0 ��������

### 4.1 ��ǿ��֤��AUTH ���ģ�

```
��������������������                                    ��������������������
�� Client ��                                    �� Server ��
���������Щ���������                                    ���������Щ���������
    ��                                             ��
    ��  �� CONNECT + AuthMethod                     ��
    ��    Properties:                             ��
    ��      AuthenticationMethod = "SCRAM-SHA-256"��
    ��������������������������������������������������������������������������������������������>��
    ��                                             ��
    ��  �� AUTH (ReasonCode = 0x18 Continue)        ��
    ��    AuthenticationData = <challenge>        ��
    ��<��������������������������������������������������������������������������������������������
    ��                                             ��
    ��  �� AUTH (ReasonCode = 0x18 Continue)        ��
    ��    AuthenticationData = <response>         ��
    ��������������������������������������������������������������������������������������������>��
    ��                                             ��
    ��  �� CONNACK (ReasonCode = 0x00 Success)      ��
    ��<��������������������������������������������������������������������������������������������
    ��                                             ��
```

### 4.2 ���������Topic Alias��

**�ͻ��ˡ�����˷���**

```csharp
// ��һ�η�������������ӳ��
PUBLISH {
    Topic = "sensors/room1/temperature",
    TopicAlias = 5,    // ������� 5
    Payload = "22.5"
}

// ����������ʹ�ñ�������ʡ�����
PUBLISH {
    Topic = "",        // ��������
    TopicAlias = 5,    // ʹ�ñ��� 5
    Payload = "23.1"
}

// ����˽����߼�
protected override PublishMessage ResolveTopicAlias(PublishMessage message)
{
    var alias = message.Properties?.TopicAlias ?? 0;
    if (alias > 0)
    {
        if (message.Topic.IsNullOrEmpty())
        {
            // ʹ�ñ���������ʵ����
            if (_topicAliasMap.TryGetValue(alias, out var topic))
                message.Topic = topic;
            else
                throw new InvalidOperationException($"δ֪�����������{alias}");
        }
        else
        {
            // ע���±���
            _topicAliasMap[alias] = message.Topic;
        }
    }
    return message;
}
```

**����ˡ��ͻ��˷����Զ����䣩��**

```csharp
// MqttHandler.cs
protected virtual PublishMessage AssignTopicAlias(PublishMessage message)
{
    var maxAlias = Capabilities?.TopicAliasMaximum ?? 0;
    if (maxAlias == 0) return message;
    
    // ����Ƿ����б���
    if (_topicToAliasMap.TryGetValue(message.Topic, out var alias))
    {
        message.Properties ??= new MqttProperties();
        message.Properties.TopicAlias = alias;
        message.Topic = "";  // ʹ�ñ������������ÿ�
    }
    else if (_topicToAliasMap.Count < maxAlias)
    {
        // �����±���
        alias = (UInt16)(_topicToAliasMap.Count + 1);
        _topicToAliasMap[message.Topic] = alias;
        
        message.Properties ??= new MqttProperties();
        message.Properties.TopicAlias = alias;
        // �״η���ʱ����������
    }
    
    return message;
}
```

### 4.3 ���أ�Receive Maximum��

```csharp
// MqttSessionCapabilities.cs
public class MqttSessionCapabilities
{
    /// <summary>�������ֵ������δȷ�ϵ� QoS>0 ��Ϣ����</summary>
    public UInt16 ReceiveMaximum { get; set; } = 65535;
    
    /// <summary>��ǰ Inflight ��Ϣ��</summary>
    private Int32 _inflightCount;
    
    /// <summary>����Ƿ���Է��� QoS>0 ��Ϣ</summary>
    public Boolean CanSendQosMessage()
    {
        return _inflightCount < ReceiveMaximum;
    }
    
    /// <summary>��Ϣ���ͺ����Ӽ���</summary>
    public void OnMessageSent()
    {
        Interlocked.Increment(ref _inflightCount);
    }
    
    /// <summary>�յ� ACK ����ټ���</summary>
    public void OnMessageAcked()
    {
        Interlocked.Decrement(ref _inflightCount);
    }
}

// MqttHandler.cs
public override Boolean Publish(PublishMessage message)
{
    if (message.QoS > 0 && !Capabilities.CanSendQosMessage())
    {
        // �����������ƣ��ݴ浽���л���
        _pendingMessages.Enqueue(message);
        return false;
    }
    
    Capabilities.OnMessageSent();
    return base.Publish(message);
}
```

### 4.4 ����ѡ�MQTT 5.0��

```csharp
// Subscription.cs
public class Subscription
{
    /// <summary>���������</summary>
    public String TopicFilter { get; set; }
    
    /// <summary>QoS</summary>
    public QualityOfService QoS { get; set; }
    
    // MQTT 5.0 ��������ѡ��
    
    /// <summary>��ת�������������Ϣ</summary>
    public Boolean NoLocal { get; set; }
    
    /// <summary>������Ϣ������ʱ��״̬ת��</summary>
    public Boolean RetainAsPublished { get; set; }
    
    /// <summary>������Ϣ�����ʽ</summary>
    /// <remarks>
    /// 0 = ����ʱ���ͱ�����Ϣ
    /// 1 = �����¶���ʱ���ͱ�����Ϣ
    /// 2 = �����ͱ�����Ϣ
    /// </remarks>
    public Byte RetainHandling { get; set; }
}
```

---

## �塢����˺���ģ��

### 5.1 MqttServer - �������

```csharp
public class MqttServer : NetServer<MqttSession>
{
    /// <summary>��Ϣ������</summary>
    public IMqttExchange Exchange { get; set; }
    
    /// <summary>��֤��</summary>
    public IMqttAuthenticator Authenticator { get; set; }
    
    /// <summary>�������</summary>
    protected override void OnStart()
    {
        // 1. ��ʼ���������ջ
        Add(new ProxyCodec());              // ProxyProtocol v1/v2
        Add(new WebSocketServerCodec());     // WebSocket ֧��
        Add(new HttpCodec());                // HTTP ֧��
        Add(new MqttCodec());                // MQTT �����
        
        // 2. ����������
        Exchange ??= new MqttExchange();
        
        // 3. ������Ⱥ��������ã�
        CreateCluster();
        
        base.OnStart();
    }
}
```

### 5.2 MqttExchange - ��Ϣ������

**ְ��**
- �Ự�����ע��/ע��/��ʱ�����
- ����·�ɣ����������ƥ�䣩
- ������Ϣ�洢
- �־ûỰ����
- $SYS ϵͳ���ⷢ��

**�������ݽṹ��**

```csharp
public class MqttExchange : DisposeBase, IMqttExchange
{
    // ��Ծ�Ự���� <SessionId, Handler>
    private ConcurrentDictionary<Int32, IMqttHandler> _sessions;
    
    // ���ⶩ�ı� <TopicFilter, List<Subscription>>
    private ConcurrentDictionary<String, List<SubscriptionItem>> _topics;
    
    // ������Ϣ�洢 <Topic, PublishMessage>
    private ConcurrentDictionary<String, PublishMessage> _retainMessages;
    
    // �־ûỰ�洢 <ClientId, PersistentSession>
    private ConcurrentDictionary<String, PersistentSession> _persistentSessions;
    
    // ClientId ӳ�� <SessionId, ClientId>
    private ConcurrentDictionary<Int32, String> _clientIdMap;
    
    // ���������ѯ���� <ShareGroup, Index>
    private ConcurrentDictionary<String, Int32> _sharedGroupIndex;
}
```

**����ƥ���㷨��**

```csharp
// MqttTopicFilter.cs
public static Boolean IsMatch(String topic, String filter)
{
    // 1. $SYS ���ⲻƥ��ͨ���
    if (topic.StartsWith("$") && filter.Contains("#") || filter.Contains("+"))
        return false;
    
    // 2. �� / �ָ�㼶
    var topicLevels = topic.Split('/');
    var filterLevels = filter.Split('/');
    
    var i = 0;
    for (; i < filterLevels.Length && i < topicLevels.Length; i++)
    {
        var f = filterLevels[i];
        var t = topicLevels[i];
        
        if (f == "#")
            return true;  // # ƥ��ʣ�����в㼶
        
        if (f != "+" && f != t)
            return false;  // + ƥ�䵥�㣬���������ȫ���
    }
    
    // 3. ���ȱ�����ȣ������� # ��β��
    return i == topicLevels.Length && i == filterLevels.Length;
}
```

**������ĸ��ؾ��⣺**

```csharp
// ������ĸ�ʽ��$share/{group}/{topic}
// ʾ����$share/group1/sensors/+/temp

public virtual void Publish(PublishMessage message)
{
    foreach (var (filter, subList) in _topics)
    {
        // ��ȡʵ�������������ȥ�� $share/group/ ǰ׺��
        var actualFilter = ExtractActualTopicFilter(filter);
        if (!MqttTopicFilter.IsMatch(message.Topic, actualFilter))
            continue;
        
        // ����ǹ�����ģ���ѯѡ��һ��������
        if (IsSharedSubscription(filter))
        {
            var group = ExtractShareGroup(filter);  // ��ȡ group
            var index = _sharedGroupIndex.AddOrUpdate(
                group, 
                0, 
                (k, v) => (v + 1) % subList.Count
            );
            
            var sub = subList[index];
            if (_sessions.TryGetValue(sub.SessionId, out var handler))
                handler.Publish(message);
        }
        else
        {
            // ��ͨ���ģ��㲥�����ж�����
            foreach (var sub in subList)
            {
                if (_sessions.TryGetValue(sub.SessionId, out var handler))
                    handler.Publish(message);
            }
        }
    }
}
```

### 5.3 InflightManager - ��Ϣ�ط�����

```csharp
public class InflightManager : DisposeBase
{
    /// <summary>δȷ����Ϣ���� <PacketId, (Message, SendTime, RetryCount)></summary>
    private ConcurrentDictionary<UInt16, (MqttMessage, DateTime, Int32)> _inflight;
    
    /// <summary>�ط���ʱʱ�䣨���룩</summary>
    public Int32 RetryTimeout { get; set; } = 10_000;
    
    /// <summary>����ط�����</summary>
    public Int32 MaxRetries { get; set; } = 3;
    
    /// <summary>���δȷ����Ϣ</summary>
    public void Add(UInt16 id, MqttMessage message)
    {
        _inflight[id] = (message, DateTime.Now, 0);
    }
    
    /// <summary>ȷ����Ϣ</summary>
    public void Ack(UInt16 id)
    {
        _inflight.TryRemove(id, out _);
    }
    
    /// <summary>��鳬ʱ���ط�</summary>
    private void CheckTimeout(Object state)
    {
        var now = DateTime.Now;
        foreach (var (id, (msg, sendTime, retryCount)) in _inflight)
        {
            if ((now - sendTime).TotalMilliseconds < RetryTimeout)
                continue;
            
            // ��ʱ����
            if (retryCount >= MaxRetries)
            {
                // �ﵽ������Դ������Ƴ�
                _inflight.TryRemove(id, out _);
                Log?.Warn($"��Ϣ {id} �ﵽ������Դ��� {MaxRetries}�������ط�");
            }
            else
            {
                // �ط���Ϣ������ DUP=1
                msg.Duplicate = true;
                _handler.Send(msg);
                
                // ����������Ϣ
                _inflight[id] = (msg, now, retryCount + 1);
                Log?.Info($"�ط���Ϣ {id}���� {retryCount + 1} ��");
            }
        }
    }
}
```

---

## ������ҵ����չ����

### 6.1 ��Ϣ�Žӣ�MqttBridge��

**�ܹ���**

```
��������������������������������                      ��������������������������������
�� Local Broker ��?������������      ����������������?��Remote Broker ��
�� (NewLife.MQTT)��      ��      ��       ��  (EMQX/...)  ��
��������������������������������      ��      ��        ��������������������������������
       ��               ��      ��               ��
       ��          �����������ة������������ة���������          ��
       ��          ��  MqttBridge    ��          ��
       ��          ��  �������������������������� ��          ��
       �����������������������੤����Local Pub  �����੤��������������������
                  ��  �������������������������� ��
       �����������������������੤����Remote Sub ���੤��������������������
       ��          ��  �������������������������� ��          ��
       ��          ������������������������������������          ��
```

**����ʾ����**

```csharp
var bridge = new MqttBridge
{
    Name = "Bridge-EMQX",
    RemoteServer = "tcp://emqx.server.com:1883",
    ClientId = "bridge_client",
    UserName = "bridge_user",
    Password = "bridge_pass",
    
    Rules = 
    {
        // ���� sensors/# -> Զ�� remote/sensors/#
        new MqttBridgeRule
        {
            Direction = BridgeDirection.Out,
            LocalTopic = "sensors/#",
            RemoteTopic = "remote/sensors/#",
            TopicPrefix = "remote/",
            MaxQoS = QualityOfService.AtLeastOnce
        },
        
        // Զ�� commands/# -> ���� commands/#
        new MqttBridgeRule
        {
            Direction = BridgeDirection.In,
            RemoteTopic = "commands/#",
            LocalTopic = "commands/#"
        }
    },
    
    Exchange = mqttServer.Exchange
};

await bridge.StartAsync();
```

### 6.2 �������棨MqttRuleEngine��

**5�ֶ������ͣ�**

| �������� | ˵�� | Ӧ�ó��� |
|---------|------|---------|
| Republish | ת������������ | ����·�ɡ���Ϣ���� |
| WebHook | ���� HTTP �ص� | ���͵��ⲿϵͳ���澯֪ͨ |
| Bridge | �Žӵ�Զ�� Broker | �� Broker ��Ϣͬ�� |
| Drop | ������Ϣ | ��Ϣ���ˡ����� |
| Custom | �Զ���ί�д��� | ���ҵ���߼� |

**����ʾ����**

```csharp
var ruleEngine = new MqttRuleEngine
{
    Exchange = mqttServer.Exchange,
    WebHook = new MqttWebHook(),
    Bridges = new Dictionary<String, MqttBridge>
    {
        ["bridge1"] = bridge1
    }
};

// ����1�����¸澯ת��
ruleEngine.AddRule(new MqttRule
{
    Name = "���¸澯",
    TopicFilter = "sensors/+/temperature",
    ActionType = RuleActionType.Custom,
    CustomAction = msg =>
    {
        var temp = Double.Parse(msg.Payload.ToStr());
        if (temp > 35)
        {
            var alert = new PublishMessage
            {
                Topic = "alerts/high_temperature",
                Payload = $"Temperature {temp}��C exceeds threshold",
                QoS = QualityOfService.AtLeastOnce
            };
            mqttServer.Exchange.Publish(alert);
        }
    }
});

// ����2����־��Ϣ���͵� WebHook
ruleEngine.AddRule(new MqttRule
{
    Name = "��־����",
    TopicFilter = "logs/#",
    ActionType = RuleActionType.WebHook,
    WebHookUrl = "https://api.example.com/webhook/mqtt"
});

// ���ɵ� MqttHandler
public class MyHandler : MqttHandler
{
    protected override MqttIdMessage OnPublish(PublishMessage message)
    {
        // ��ִ�й�������
        var shouldDeliver = RuleEngine.ProcessMessage(message, ClientId);
        
        if (shouldDeliver)
            return base.OnPublish(message);  // ��������Ͷ��
        else
            return message.CreateAck();  // �������������� ACK
    }
}
```

### 6.3 WebHook �¼�����

**6���¼����ͣ�**

```csharp
public enum WebHookEvent
{
    ClientConnected,      // �ͻ�������
    ClientDisconnected,   // �ͻ��˶Ͽ�
    MessagePublish,       // ��Ϣ����
    MessageDelivered,     // ��ϢͶ��
    ClientSubscribe,      // �ͻ��˶���
    ClientUnsubscribe     // �ͻ���ȡ������
}
```

**����ʾ����**

```csharp
var webHook = new MqttWebHook
{
    Endpoints = 
    {
        new WebHookEndpoint
        {
            Url = "https://api.example.com/webhook/mqtt",
            Events = 
            {
                WebHookEvent.ClientConnected,
                WebHookEvent.ClientDisconnected,
                WebHookEvent.MessagePublish
            },
            MaxRetries = 3,
            Timeout = 5000
        }
    }
};

// ���ɵ� MqttHandler
protected override ConnAck OnConnect(ConnectMessage message)
{
    var ack = base.OnConnect(message);
    if (ack.Code == ConnectReturnCode.Accepted)
    {
        WebHook?.OnClientConnected(ClientId, message.Username);
    }
    return ack;
}
```

### 6.4 ��Ⱥ��ClusterServer��

**�ܹ���**

```
����������������������������       ����������������������������       ����������������������������
��  Node 1    ��?����������?��  Node 2    ��?����������?��  Node 3    ��
��  :1883     ��       ��  :1883     ��       ��  :1883     ��
��  :2883     ��       ��  :2883     ��       ��  :2883     ��
����������������������������       ����������������������������       ����������������������������
     MQTT                 MQTT                 MQTT
     Cluster              Cluster              Cluster
```

**�������̣�**

1. **Join ���뼯Ⱥ��** ���ʱ�������ڵ㷢�� Join ����
2. **Ping �������** ÿ 15 �������нڵ㷢�� Ping
3. **Subscribe ͬ����** �ͻ��˶���ʱ�㲥�����нڵ�
4. **Publish ת����** �������������ƥ�䣬ת�����ж����ߵĽڵ�
5. **Lease �뿪��Ⱥ��** ֹͣʱ֪ͨ�����ڵ�

**����ʾ����**

```csharp
var server = new MqttServer
{
    Port = 1883,
    ClusterPort = 2883,
    ClusterNodes = new[]
    {
        "192.168.1.101:2883",
        "192.168.1.102:2883",
        "192.168.1.103:2883"
    }
};
```

---

## �ߡ���������

### 7.1 ���ִ���Э��

| ���䷽ʽ | �ͻ��� | ����� | Ĭ�϶˿� | �ص� |
|---------|--------|--------|---------|------|
| TCP | ? | ? | 1883 | ��׼ MQTT ���� |
| TCP + TLS | ? | ? | 8883 | X509 ֤����� |
| WebSocket | ? | ? | 8083 | ws:// Э�飬HTTP ���� |
| WSS | ? | ? | 8884 | wss:// Э�飬TLS ���� |
| QUIC | ? | — | 14567 | .NET 7+ 平台，基于 System.Net.Quic，低延迟无队头阻塞（.NET 7/8 需启用预览特性） |
| �ɿ� UDP | ? | ? | 1883 | ����Э�飬ȫƽ̨���� |

### 7.2 MQTT over QUIC

**���ƣ�**
- **���ӳ٣�** 0-RTT ���ӽ���
- **�޶�ͷ������** ��·����������
- **�ƶ��Ѻã�** ����Ǩ�ƣ�Connection Migration��

**ʵ�֣�**

```csharp
public class MqttQuicClient : DisposeBase
{
    private QuicConnection? _connection;
    private QuicStream? _stream;
    
    public async Task ConnectAsync()
    {
        var options = new QuicClientConnectionOptions
        {
            RemoteEndPoint = new DnsEndPoint(Server, Port),
            ClientAuthenticationOptions = new SslClientAuthenticationOptions
            {
                ApplicationProtocols = [new SslApplicationProtocol("mqtt")]
            }
        };
        
        _connection = await QuicConnection.ConnectAsync(options);
        _stream = await _connection.OpenOutboundStreamAsync(QuicStreamType.Bidirectional);
    }
    
    public async Task SendAsync(MqttMessage message)
    {
        var data = message.ToArray();
        await _stream.WriteAsync(data);
    }
}
```

### 7.3 MQTT over �ɿ� UDP

**֡��ʽ��**

```
�������������������Щ����������������Щ����������������Щ�����������������������������
��  Type  ��  Seq   ��  Len   ��   Payload    ��
�� (1�ֽ�)�� (2�ֽ�)�� (1�ֽ�)��   (�䳤)      ��
�������������������ة����������������ة����������������ة�����������������������������

Type:
  0x01 = Data      ����֡
  0x02 = Ack       ȷ��֡
  0x03 = Connect   ����֡
  0x04 = ConnAck   ����ȷ��֡
  0x05 = Close     �ر�֡
```

**�ɿ��Ա�֤��**

```csharp
public class MqttUdpTransport
{
    private UInt16 _sequence;
    private ConcurrentDictionary<UInt16, (Byte[], DateTime, Int32)> _unacked;
    
    public async Task SendAsync(Byte[] data)
    {
        var seq = _sequence++;
        var frame = BuildFrame(FrameType.Data, seq, data);
        
        // ��������֡
        await _socket.SendAsync(frame, _remoteEP);
        
        // ����δȷ�϶���
        _unacked[seq] = (frame, DateTime.Now, 0);
    }
    
    private void OnReceive(Byte[] frame)
    {
        var type = (FrameType)frame[0];
        var seq = BitConverter.ToUInt16(frame, 1);
        
        if (type == FrameType.Data)
        {
            // �ظ� ACK
            var ack = BuildFrame(FrameType.Ack, seq, null);
            _socket.SendAsync(ack, _remoteEP);
            
            // ��������
            ProcessData(frame);
        }
        else if (type == FrameType.Ack)
        {
            // �Ƴ���ȷ�ϵ�֡
            _unacked.TryRemove(seq, out _);
        }
    }
    
    private void CheckRetransmit()
    {
        var now = DateTime.Now;
        foreach (var (seq, (frame, sendTime, retryCount)) in _unacked)
        {
            if ((now - sendTime).TotalMilliseconds > RetryTimeout)
            {
                if (retryCount < MaxRetries)
                {
                    _socket.SendAsync(frame, _remoteEP);
                    _unacked[seq] = (frame, now, retryCount + 1);
                }
                else
                {
                    _unacked.TryRemove(seq, out _);
                }
            }
        }
    }
}
```

### 7.4 ProxyProtocol ֧��

**Ŀ�ģ�** �� nginx/HAProxy �����͸����ʵ�ͻ��� IP

**v1 ��ʽ���ı�����**

```
PROXY TCP4 192.168.1.100 10.0.0.1 5678 1883\r\n
<MQTT ������...>
```

**v2 ��ʽ�������ƣ���**

```
������������������������������������������������������������������������������������������������
��  Signature (12�ֽ�)                          ��
��  \x0D\x0A\x0D\x0A\x00\x0D\x0A\x51\x55\x49\x54\x0A��
������������������������������������������������������������������������������������������������
��  Ver/Cmd (1�ֽ�) �� Family (1�ֽ�)            ��
��  Length (2�ֽ�)                              ��
������������������������������������������������������������������������������������������������
��  Source Address + Dest Address + Ports      ��
������������������������������������������������������������������������������������������������
```

**����ʵ�֣�**

```csharp
public class ProxyCodec : Handler
{
    protected override Object Decode(IHandlerContext context, IPacket pk)
    {
        var stream = pk.GetStream();
        var first = (Byte)stream.ReadByte();
        stream.Position = 0;
        
        if (first == 'P')  // "PROXY" v1
        {
            var line = stream.ReadLine();
            var msg = new ProxyMessage();
            msg.Parse(line);
            return msg;
        }
        else if (first == 0x0D)  // v2 signature
        {
            var msg = new ProxyMessageV2();
            msg.Read(stream, context);
            return msg;
        }
        
        return base.Decode(context, pk);
    }
}
```

---

## �ˡ������Ż����

### 8.1 �������ݽṹ

```csharp
// ʹ�� ConcurrentDictionary ����������
private ConcurrentDictionary<Int32, IMqttHandler> _sessions;
private ConcurrentDictionary<String, List<SubscriptionItem>> _topics;
private ConcurrentDictionary<String, PublishMessage> _retainMessages;

// ʹ�� Interlocked ԭ�Ӳ���
Interlocked.Increment(ref Stats.MessagesReceived);
Interlocked.Decrement(ref Stats.ConnectedClients);
```

### 8.2 ����ػ�

```csharp
// ArrayPool �����ֽ�����
var buffer = ArrayPool<Byte>.Shared.Rent(4096);
try
{
    // ʹ�� buffer
}
finally
{
    ArrayPool<Byte>.Shared.Return(buffer);
}

// StringBuilder �ػ���NewLife.Core �ṩ��
var sb = Pool.StringBuilder.Get();
try
{
    sb.Append(...);
    return sb.ToString();
}
finally
{
    Pool.StringBuilder.Put(sb);
}
```

### 8.3 �㿽�����л�

```csharp
// ʹ�� IPacket �ӿڣ������θ���
public class PublishMessage : MqttIdMessage
{
    public IPacket? Payload { get; set; }  // ���� Byte[]
    
    protected override Boolean OnWrite(Stream stream, Object? context)
    {
        WriteString(stream, Topic);
        if (QoS > 0) base.OnWrite(stream, context);
        
        // ֱ�� CopyTo������ ToArray()
        Payload?.CopyTo(stream);
        return true;
    }
}
```

### 8.4 ����׷�٣�ITracer��

```csharp
// ÿ���ؼ��������� Span ���
public async Task<ConnAck> ConnectAsync()
{
    using var span = Tracer?.NewSpan("mqtt:Connect");
    try
    {
        var msg = new ConnectMessage { ... };
        var ack = await SendAsync<ConnAck>(msg);
        return ack;
    }
    catch (Exception ex)
    {
        span?.SetError(ex, null);
        throw;
    }
}

// ���� OpenTelemetry / APM ϵͳ
var tracer = new DefaultTracer
{
    ServiceName = "MqttServer",
    ExporterUrl = "http://jaeger:14268/api/traces"
};
mqttServer.Tracer = tracer;
```

---

## �š�����չ�ܹ�

### 9.1 ����ע�루DI��

```csharp
// ע�����
var services = ObjectContainer.Current;
services.AddSingleton<ILog>(XTrace.Log);
services.AddSingleton<IMqttExchange, MyCustomExchange>();
services.AddTransient<IMqttHandler, MyCustomHandler>();
services.AddSingleton<IMqttAuthenticator, MyAuthenticator>();

var server = new MqttServer
{
    ServiceProvider = services.BuildServiceProvider()
};
```

### 9.2 �Զ�����Ϣ������

```csharp
public class RedisExchange : MqttExchange
{
    private readonly ConnectionMultiplexer _redis;
    
    // �־û����ĵ� Redis
    public override void Subscribe(Int32 sessionId, Subscription sub)
    {
        base.Subscribe(sessionId, sub);
        
        var db = _redis.GetDatabase();
        db.HashSet($"mqtt:subs:{sessionId}", sub.TopicFilter, sub.QoS);
    }
    
    // �� Redis �ָ��־ûỰ
    public override void RestorePersistentSession(IMqttHandler handler, String clientId)
    {
        var db = _redis.GetDatabase();
        var subs = db.HashGetAll($"mqtt:subs:{handler.SessionId}");
        
        foreach (var (field, value) in subs)
        {
            var sub = new Subscription
            {
                TopicFilter = field,
                QoS = (QualityOfService)(Int32)value
            };
            Subscribe(handler.SessionId, sub);
        }
    }
}
```

### 9.3 �Զ�����֤��

```csharp
public class DatabaseAuthenticator : IMqttAuthenticator
{
    private readonly IDbContext _db;
    
    public ConnectReturnCode Authenticate(String? clientId, String? username, String? password)
    {
        if (username.IsNullOrEmpty()) return ConnectReturnCode.BadUserNameOrPassword;
        
        var user = _db.Users.FirstOrDefault(u => u.Username == username);
        if (user == null) return ConnectReturnCode.BadUserNameOrPassword;
        
        if (!PasswordHelper.Verify(password, user.PasswordHash))
            return ConnectReturnCode.BadUserNameOrPassword;
        
        return ConnectReturnCode.Accepted;
    }
    
    public Boolean AuthorizePublish(String? clientId, String topic)
    {
        var user = _db.Users.FirstOrDefault(u => u.ClientId == clientId);
        return user?.Permissions.Any(p => p.Type == "publish" && IsMatch(topic, p.Topic)) ?? false;
    }
    
    public Boolean AuthorizeSubscribe(String? clientId, String topicFilter)
    {
        var user = _db.Users.FirstOrDefault(u => u.ClientId == clientId);
        return user?.Permissions.Any(p => p.Type == "subscribe" && IsMatch(topicFilter, p.Topic)) ?? false;
    }
}
```

---

## ʮ���ܽ�

NewLife.MQTT ����**�ֲ�ܹ� + ��������**��ʵ���� MQTT 3.1.1 �� MQTT 5.0 Э�������֧�֡��������ư�����

1. **Э�������ԣ�** 15�ֱ������͡�30�� MQTT 5.0 ���ԡ�QoS 0/1/2��Retain/Will/�Ự/����/���صȺ��Ĺ���ȫ��ʵ��
2. **��������ԣ�** TCP/TLS/WS/WSS/QUIC/UDP ���ִ��䷽ʽ��ҵ�縲�������
3. **��ҵ�����ܣ�** ��Ⱥ/�Ž�/��������/WebHook/ProxyProtocol �������
4. **����չ�ԣ�** ���� DI �Ĳ�����ܹ���֧���Զ��� Handler/Exchange/Authenticator
5. **�����ܣ�** �������ݽṹ������ػ����㿽�����л�������׷��
6. **��������** ������ NewLife.Core��MIT ��Դ���޹�Ӧ������

**���ó�����**
- �������豸����ƽ̨
- ��ҵ���������ݲɼ�
- ���ܼҾ���Ϣ����
- ��������Ϣƽ̨
- ��Ե��������
- �Ŵ���������Ŀ

���꣩

